<!DOCTYPE html>
<html>

<head>
    <title>车联网demo</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <link type="text/css" rel="stylesheet" href="car2.min.css?v=07072017165025">
    <script type="text/javascript" src="./b4w.min.js?v=07072017165025"></script>
    <script type="text/javascript" src="car2.min.js?v=07072017165025"></script>
    <script src="https://iot2.cdn.bcebos.com/static/browserMqtt.js"></script>
    </head>

    <body>
        <div id="main_canvas_container"></div>
        <div class='button'>
            <button id='opendoor'>开门</button>
            <button id='closedoor'>关门</button>
            <button id='openwindow'>开窗</button>
            <button id='closewindow'>关窗</button>
            <button id='openlamp'>开灯</button>
            <button id='closelamp'>关灯</button>
        </div>
        <div class="screen">
            <div class="bao">
                <div class="title">运行状态</div>
                <div class="chetan">
                    <div id="lun1">2.5MP</div>
                    <div id="lun2">2.5MP</div>
                    <div id="lun3">2.5MP</div>
                    <div id="lun4">2.5MP</div>
                </div>
                <div class="status">
                    <div id="yasuoji">压缩机正常</div>
                    <div id="lengdongji">冷冻机正常</div>
                </div>

                <div class="yibiao">
                    <span class="shisu">时速</span>
                    <span class="sudu">65</span>
                    <span class="licheng" id='esm'>10034km</span>
                </div>

                <div id="time"></div>
                <div class="long">
                    <div class="temp"><span class="guan" id="a0"></span><span class="tmp" id="tmp2">80%</span><span class="text">油量</span></div>
                    <div class="temp"><span class="guan" id="a1"></span><span class="tmp" id="tmp1">30℃</span><span class="text">车内</span></div>
                    <div class="temp"><span class="guan" id="a2"></span><span class="tmp" id="tmp2">38℃</span><span class="text">车外</span></div>
                    <div id="temperature">OFF</div>
                    <div id="temperature1">ON</div>
                </div>
            </div>
        </div>
        <script type="text/javascript">
            var time = new Date();
            document.getElementById("time").innerHTML = time.getHours() + ':' + ((time.getMinutes()+'').length === 1? `0${time.getMinutes()}`: time.getMinutes());


            const host = 'smartsvcdemo.mqtt.iot.gz.baidubce.com';
            const port = 8884;
            const clientId = `DeviceId-${Date.parse(new Date())}`;
            var client = new Mqtt.Client(host, port, clientId);
            client.onConnectionLost = function() {
                console.log('disconnect');
            }
            client.onMessageArrived = function(message) {
                console.log(message.payloadString);
                var re = /^[0-9]+\.?[0-9]*$/;
                if(message.destinationName==='controlDoor'&&message.payloadString === 'open') {
                     document.getElementById('opendoor').click();
                }
                else if(message.destinationName==='controlDoor'&&message.payloadString === 'close') {
                     document.getElementById('closedoor').click();
                }
                else if(message.destinationName==='controlWindow'&&message.payloadString === 'open') {
                     document.getElementById('openwindow').click();
                }
                else if(message.destinationName==='controlWindow'&&message.payloadString === 'close') {
                     document.getElementById('closewindow').click();
                }
                else if(message.destinationName==='controlLight'&&message.payloadString === 'open') {
                     document.getElementById('openlamp').click();
                }
                else if(message.destinationName==='controlLight'&&message.payloadString === 'close') {
                     document.getElementById('closelamp').click();
                }
                else if(message.destinationName==='regulateTemperature'&&message.payloadString === 'open') {
                     document.getElementById('temperature').style.display = 'none';
                     document.getElementById('temperature1').style.display = 'block';
                }
                else if(message.destinationName==='regulateTemperature'&&message.payloadString === 'close') {
                     document.getElementById('temperature').style.display = 'block';
                     document.getElementById('temperature1').style.display = 'none';
                }
                else if(message.destinationName==='regulateTemperature') {
                    if (re.test(message.payloadString)) {
                        document.getElementById('tmp1').innerHTML = `${message.payloadString}℃`;
                        document.getElementById('tmp1').style.height = `${message.payloadString/50*100}%`;
                    }
                }
                else if(message.destinationName==='PSI01'&&re.test(message.payloadString)) {
                    document.getElementById('lun1').innerHTML = `${message.payloadString}MP`;
                    if(parseFloat(message.payloadString) > 2.0 && parseFloat(message.payloadString)<3.0) {
                        document.getElementById('lun1').style.background = '#5c5858';
                    }
                    else {
                        document.getElementById('lun1').style.background = 'red';
                    }
                }
                else if(message.destinationName==='PSI02'&&re.test(message.payloadString)) {
                    document.getElementById('lun2').innerHTML = `${message.payloadString}MP`;
                    if(parseFloat(message.payloadString) > 2.0 && parseFloat(message.payloadString)<3.0) {
                        document.getElementById('lun2').style.background = '#5c5858';
                    }
                    else {
                        document.getElementById('lun2').style.background = 'red';
                    }
                }
                else if(message.destinationName==='PSI03'&&re.test(message.payloadString)) {
                    document.getElementById('lun3').innerHTML = `${message.payloadString}MP`;
                    if(parseFloat(message.payloadString) > 2.0 && parseFloat(message.payloadString)<3.0) {
                        document.getElementById('lun3').style.background = '#5c5858';
                    }
                    else {
                        document.getElementById('lun3').style.background = 'red';
                    }
                }
                else if(message.destinationName==='PSI04'&&re.test(message.payloadString)) {
                    document.getElementById('lun4').innerHTML = `${message.payloadString}MP`;
                    if(parseFloat(message.payloadString) > 2.0 && parseFloat(message.payloadString)<3.0) {
                        document.getElementById('lun4').style.background = '#5c5858';
                    }
                    else {
                        document.getElementById('lun4').style.background = 'red';
                    }
                }
                else if(message.destinationName==='compressor') {
                    if (message.payloadString == 'warn') {
                        document.getElementById('yasuoji').innerHTML = '压缩机异常';
                    }
                    else if (message.payloadString == 'ok') {
                        document.getElementById('yasuoji').innerHTML = '压缩机正常';
                    }
                }
                else if(message.destinationName==='refrigerator') {
                    if (message.payloadString == 'warn') {
                        document.getElementById('lengdongji').innerHTML = '冷冻机异常';
                    }
                    else if (message.payloadString == 'ok') {
                        document.getElementById('lengdongji').innerHTML = '冷冻机正常';
                    }
                }
                else if(message.destinationName==='esm'&&re.test(message.payloadString)) {
                    document.getElementById('esm').innerHTML = `${message.payloadString}km`;
                }
            }
            var options = {
                timeout: 3,
                keepAliveInterval: 90,
                cleanSession: true,
                useSSL: true,
                onSuccess: () => {
                    console.log('success');
                    client.subscribe('controlDoor', {qos: 0});
                    client.subscribe('controlWindow', {qos: 0});
                    client.subscribe('controlLight', {qos: 0});
                    client.subscribe('regulateTemperature', {qos: 0});
                    client.subscribe('controlDoor', {qos: 0});
                    client.subscribe('PSI04', {qos: 0});
                    client.subscribe('PSI01', {qos: 0});
                    client.subscribe('PSI02', {qos: 0});
                    client.subscribe('PSI03', {qos: 0});
                    client.subscribe('compressor', {qos: 0});
                    client.subscribe('refrigerator', {qos: 0});
                    client.subscribe('esm', {qos: 0});
                },
                onFailure: () => {alert('fail');}
            };
            options.userName = 'smartsvcdemo/carweb';
            options.password = 'RKP0pH8leTcdKwNO6M2k985izrIYROfHqhogR3vn010=';
            try {
                client.connect(options);
            }
            catch (err) {
                alert(err);
            }
        </script>
    </body>

</html>
